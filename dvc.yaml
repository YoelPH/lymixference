vars:
- params.yaml

stages:
  join:
    wdir: .
    desc: Concatenate any number of datasets so they can be used as one for training
    vars:
    - output: data/joined.csv
    cmd: >
      lyscripts data join
      --inputs 2021-usz-oropharynx/data.csv 2021-clb-oropharynx/data.csv 2023-isb-multisite/data.csv 2023-clb-multisite/data.csv 2024-hvh-oropharynx/data.csv data/UMC.csv data/USZ2.csv
      --output ${output}
    deps:
    - 2021-usz-oropharynx/data.csv
    - 2021-clb-oropharynx/data.csv
    - 2023-isb-multisite/data.csv
    - 2023-clb-multisite/data.csv
    - 2024-hvh-oropharynx/data.csv
    - data/UMC.csv
    - data/USZ2.csv
    outs:
    - ${output}

  enhance:
    wdir: .
    desc:
      This stage fixes the super- and sub-level reporting for the LNLs and also creates
      new 'modalities' from combining existing ones, e.g. using the logical AND or
      estimating the most likely involvement based on the observations only.
    vars:
    - input: data/joined.csv
    - output: data/enhanced.csv
    cmd: >
      lyscripts data enhance ${input} ${output} ${data_cleaning_modalities}
    deps:
    - ${input}
    params:
    - modalities
    outs:
    - ${output}

  filter:
    wdir: .
    desc:
      Select patients with oral cavity, oropharynx, hypopharynx and larynx subsites.
      Further reduce the ICD codes.
    cmd: >
      python scripts/filter_and_reduce.py
      --input data/enhanced.csv
      --output data/filtered.csv
    deps:
      - scripts/filter_and_reduce.py
      - data/enhanced.csv
    params:
    - general
    outs:
      - data/filtered.csv

  fitting:
    wdir: .
    desc:
      Fit mixture model 
    cmd: >
      lyscripts mixture_fit -i ${general.data}
    deps:
    - ${general.data}
    params:
    - graph
    - model
    - em
    - modalities
    - general

  plot-mixture-matrix:
    wdir: .
    desc: Plots the mixture component matrix.
    cmd: >
      lyscripts plot mixture_plot
      --input ${general.history_dir}/mixture_coef.csv
      --output ${general.plots_dir}/mixture_matrix.png
    deps:
    - ${general.history_dir}
    plots:
    - ${general.plots_dir}/mixture_matrix.png
    - ${general.plots_dir}/mixture_matrix.svg

  # plot-simplex:
  #   wdir: .
  #   desc: Plots the simplex representation of the mixture coefficients
  #   cmd: >
  #     lyscripts plot simplex_plot
  #     --input ${general.history_dir}/mixture_coef.csv
  #     --output ${general.plots_dir}/simplex.png
  #   deps:
  #   - ${general.history_dir}
  #   plots:
  #   - ${general.plots_dir}/simplex.png
  #   - ${general.plots_dir}/simplex.svg
  #   params:
  #   - general

